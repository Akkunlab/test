<!-- === ble-haptic.html (Service-UUID filter + write with response + PING after connect) === -->
<!doctype html>
<meta charset="utf-8" />
<title>Haptic Control (Web Bluetooth)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
         margin: 0; padding: 24px; line-height: 1.4; }
  h1 { font-size: 20px; margin: 0 0 12px; }
  button { font-size: 16px; padding: 10px 14px; margin: 6px 8px 6px 0; border-radius: 8px; border: 1px solid #ccc;
           background: #fafafa; cursor: pointer; }
  #log { white-space: pre-wrap; border: 1px solid #ddd; border-radius: 8px; padding: 10px; height: 220px; overflow:auto; }
</style>

<h1>🟦 M5 Haptic (Web Bluetooth)</h1>
<p>
  <button id="btnConnect">🔗 Connect</button>
  <button id="btnPulse">💥 PULSE 200ms</button>
  <button id="btnOn">▶️ ON (click once)</button>
  <button id="btnOff">⏹ OFF</button>
</p>
<div id="log"></div>

<script>
  const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
  const RX_UUID      = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write
  const TX_UUID      = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify (optional)

  let device, server, service, rxChar, txChar;

  const log = (...args) => {
    const el = document.getElementById('log');
    el.textContent += args.join(' ') + '\n';
    el.scrollTop = el.scrollHeight;
    console.log(...args);
  };

  async function connect() {
    try {
      device = await navigator.bluetooth.requestDevice({
        filters: [{ services: [SERVICE_UUID] }],  // ← サービスUUIDでフィルタ
        optionalServices: [SERVICE_UUID]
      });
      device.addEventListener('gattserverdisconnected', () => log('💔 Disconnected'));

      server  = await device.gatt.connect();
      service = await server.getPrimaryService(SERVICE_UUID);
      rxChar  = await service.getCharacteristic(RX_UUID);
      try {
        txChar  = await service.getCharacteristic(TX_UUID);
        await txChar.startNotifications();
        txChar.addEventListener('characteristicvaluechanged', (e) => {
          const v = new TextDecoder().decode(e.target.value);
          log('🔔 Notify:', v);
        });
      } catch (e) { log('ℹ️ no TX notify:', e.message || e); }

      log('✅ Connected to', device.name || '(no name)');
      // 疎通確認：PING → PONG の往復確認
      await rxChar.writeValue(new TextEncoder().encode('PING'));
      log('➡️ Send: PING');
    } catch (e) {
      log('❌', e.message || e);
    }
  }

  async function send(cmd) {
    if (!rxChar) { log('⚠️ Not connected'); return; }
    try {
      await rxChar.writeValue(new TextEncoder().encode(cmd)); // 応答ありで確実に
      log('➡️ Send (ack):', cmd);
    } catch (err) {
      log('❌ write failed:', err.message || err);
    }
  }

  document.getElementById('btnConnect').onclick = connect;
  document.getElementById('btnPulse').onclick   = () => send('P200');
  document.getElementById('btnOn').onclick      = () => send('ON');
  document.getElementById('btnOff').onclick     = () => send('OFF');
</script>
